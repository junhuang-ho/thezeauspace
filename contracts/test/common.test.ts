import { time, loadFixture } from "@nomicfoundation/hardhat-network-helpers";
import { type SignerWithAddress } from "@nomiclabs/hardhat-ethers/signers";
import { expect } from "chai";
import { Contract, type BigNumber } from "ethers";
import hre, { ethers } from "hardhat";
import { main as deployBounty } from "../scripts/deploy.setup";
import { ZERO_BYTES, networkConfig } from "../utils/common";

const chainId = hre.network.config.chainId;
const CHAIN_ID_MUMBAI = 80001;
export const ADDRESS_GELATO_AUTOBOT =
  networkConfig[chainId ?? CHAIN_ID_MUMBAI]["addrGelAutobot"];
// export const MINIMUM_DEPOSIT_AMOUNT = ethers.utils.parseEther("3"); // 1
export const MINIMUM_FLOW_AMOUNT = ethers.utils.parseEther("2"); // 2
export const MINIMUM_DEPOSIT_AMOUNT = MINIMUM_FLOW_AMOUNT.sub(
  ethers.utils.parseEther("1")
);
export const MAX_FLOW_DURATION_PER_UNIT_FLOW_AMOUNT = 4092000; // 2592000 = 1 month in seconds
export const MIN_CONTRACT_GELATO_BALANCE = ethers.utils.parseEther("0.5");
export const ST_BUFFER_DURATION_IN_SECONDS = 3600;
export const ST_ADDRESSES = [
  networkConfig[chainId ?? CHAIN_ID_MUMBAI]["addrUSDCx"],
];

export const MIN_APP_GELATO_BALANCE = ethers.utils.parseEther("0.5");
export const MINIMUM_END_DURATION = 60;
export const MINIMUM_LIFESPAN = 180;

const SOME_SUPER_BIG_FLOW_RATE = "99999000000000000000000";
const PTR_720 = {
  "40": { gte: "225000000000000", lt: "300000000000000", bps: 4000 },
  "30": { gte: "300000000000000", lt: "450000000000000", bps: 3000 },
  "20": { gte: "450000000000000", lt: "600000000000000", bps: 2000 },
  "15": { gte: "600000000000000", lt: "900000000000000", bps: 1500 },
  "10": { gte: "900000000000000", lt: "1800000000000000", bps: 1000 },
  "5": { gte: "1800000000000000", lt: SOME_SUPER_BIG_FLOW_RATE, bps: 500 },
}; // ref: https://docs.google.com/spreadsheets/d/1mx5hVm7k5jS4_htJNEfYTasWxx2Pcni0C1gqdQdWdaA/edit#gid=912411221

const PTR_1080 = {
  "40": { gte: "300000000000000", lt: "400000000000000", bps: 4000 },
  "30": { gte: "400000000000000", lt: "600000000000000", bps: 3000 },
  "20": { gte: "600000000000000", lt: "800000000000000", bps: 2000 },
  "15": { gte: "800000000000000", lt: "1200000000000000", bps: 1500 },
  "10": { gte: "1200000000000000", lt: "2400000000000000", bps: 1000 },
  "5": { gte: "2400000000000000", lt: SOME_SUPER_BIG_FLOW_RATE, bps: 500 },
}; // ref: https://docs.google.com/spreadsheets/d/1mx5hVm7k5jS4_htJNEfYTasWxx2Pcni0C1gqdQdWdaA/edit#gid=912411221

export const BPS720 = [
  PTR_720["40"].bps,
  PTR_720["30"].bps,
  PTR_720["20"].bps,
  PTR_720["15"].bps,
  PTR_720["10"].bps,
  PTR_720["5"].bps,
];
export const FRLB720 = [
  PTR_720["40"].gte,
  PTR_720["30"].gte,
  PTR_720["20"].gte,
  PTR_720["15"].gte,
  PTR_720["10"].gte,
  PTR_720["5"].gte,
];
export const FRUB720 = [
  PTR_720["40"].lt,
  PTR_720["30"].lt,
  PTR_720["20"].lt,
  PTR_720["15"].lt,
  PTR_720["10"].lt,
  PTR_720["5"].lt,
];
export const TAG720 = [0, 1, 2, 3, 4, 5];

/////

export const BPS1080 = [
  PTR_1080["40"].bps,
  PTR_1080["30"].bps,
  PTR_1080["20"].bps,
  PTR_1080["15"].bps,
  PTR_1080["10"].bps,
  PTR_1080["5"].bps,
];
export const FRLB1080 = [
  PTR_1080["40"].gte,
  PTR_1080["30"].gte,
  PTR_1080["20"].gte,
  PTR_1080["15"].gte,
  PTR_1080["10"].gte,
  PTR_1080["5"].gte,
];
export const FRUB1080 = [
  PTR_1080["40"].lt,
  PTR_1080["30"].lt,
  PTR_1080["20"].lt,
  PTR_1080["15"].lt,
  PTR_1080["10"].lt,
  PTR_1080["5"].lt,
];
export const TAG1080 = [6, 7, 8, 9, 10, 11];

/**
 * 
·------------------------------------------------|----------------------------|-------------|-----------------------------·
|              Solc version: 0.8.18              ·  Optimizer enabled: false  ·  Runs: 200  ·  Block limit: 30000000 gas  │
·················································|····························|·············|······························
|  Methods                                       ·               50 gwei/gas                ·       1848.70 usd/eth       │
··················|······························|··············|·············|·············|···············|··············
|  Contract       ·  Method                      ·  Min         ·  Max        ·  Avg        ·  # calls      ·  usd (avg)  │
··················|······························|··············|·············|·············|···············|··············
|  AccessControl  ·  grantRole                   ·           -  ·          -  ·      57208  ·            8  ·       5.29  │
··················|······························|··············|·············|·············|···············|··············
|  AccessControl  ·  renounceRole                ·       29498  ·      29915  ·      29707  ·            4  ·       2.75  │
··················|······························|··············|·············|·············|···············|··············
|  AccessControl  ·  revokeRole                  ·           -  ·          -  ·      35354  ·            2  ·       3.27  │
··················|······························|··············|·············|·············|···············|··············
|  Automate       ·  depositGelatoFunds          ·           -  ·          -  ·     144914  ·           84  ·      13.40  │
··················|······························|··············|·············|·············|···············|··············
|  Automate       ·  setMinimumAppGelatoBalance  ·           -  ·          -  ·      34684  ·            2  ·       3.21  │
··················|······························|··············|·············|·············|···············|··············
|  Automate       ·  withdrawGelatoFunds         ·           -  ·          -  ·      65331  ·            2  ·       6.04  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  addSuperToken               ·           -  ·          -  ·      52201  ·           20  ·       4.83  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  clearBPS                    ·           -  ·          -  ·     136943  ·            2  ·      12.66  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  depositAsset                ·      194696  ·     228896  ·     228062  ·           82  ·      21.08  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  realizeFeeBalance           ·       32270  ·     117580  ·      79852  ·           42  ·       7.38  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  removeSuperToken            ·           -  ·          -  ·      30275  ·            2  ·       2.80  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  setBPS                      ·      574020  ·     596648  ·     575761  ·           52  ·      53.22  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  setMinimumEndDuration       ·           -  ·          -  ·      34744  ·            2  ·       3.21  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  setMinimumLifespan          ·           -  ·          -  ·      34722  ·            2  ·       3.21  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  setSBPS                     ·           -  ·          -  ·      52678  ·            6  ·       4.87  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  setSTBufferAmount           ·           -  ·          -  ·      34800  ·            2  ·       3.22  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  toggleBPS                   ·       29727  ·      51627  ·      50715  ·           48  ·       4.69  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  withdrawAsset               ·           -  ·          -  ·     171984  ·            2  ·      15.90  │
··················|······························|··············|·············|·············|···············|··············
|  Control        ·  withdrawFeeBalance          ·      170248  ·     170272  ·     170260  ·            4  ·      15.74  │
··················|······························|··············|·············|·············|···············|··············
|  Cut            ·  diamondCut                  ·           -  ·          -  ·    2813275  ·            2  ·     260.05  │
··················|······························|··············|·············|·············|···············|··············
|  Flow           ·  closeFlow                   ·      402607  ·     417916  ·     404644  ·           56  ·      37.40  │
··················|······························|··············|·············|·············|···············|··············
|  Flow           ·  depositSuperToken           ·      177495  ·     228856  ·     212674  ·          102  ·      19.66  │
··················|······························|··············|·············|·············|···············|··············
|  Flow           ·  openFlow                    ·      735011  ·     933943  ·     887738  ·          121  ·      82.06  │
··················|······························|··············|·············|·············|···············|··············
|  Flow           ·  withdrawSuperTokens         ·      198013  ·     335659  ·     233983  ·           12  ·      21.63  │
··················|······························|··············|·············|·············|···············|··············
|  Session        ·  startSessions               ·      172135  ·     277226  ·     186990  ·          110  ·      17.28  │
··················|······························|··············|·············|·············|···············|··············
|  Session        ·  stopSessions                ·      103290  ·     329826  ·     203645  ·           20  ·      18.82  │
··················|······························|··············|·············|·············|···············|··············
|  Utility        ·  withdrawNativeBalance       ·           -  ·          -  ·      58997  ·            2  ·       5.45  │
··················|······························|··············|·············|·············|···············|··············
|  Deployments                                   ·                                          ·  % of limit   ·             │
·················································|··············|·············|·············|···············|··············
|  AccessControl                                 ·           -  ·          -  ·     827413  ·        2.8 %  ·      76.48  │
·················································|··············|·············|·············|···············|··············
|  Automate                                      ·           -  ·          -  ·    1006518  ·        3.4 %  ·      93.04  │
·················································|··············|·············|·············|···············|··············
|  Control                                       ·           -  ·          -  ·    3408048  ·       11.4 %  ·     315.02  │
·················································|··············|·············|·············|···············|··············
|  Cut                                           ·           -  ·          -  ·    2345034  ·        7.8 %  ·     216.76  │
·················································|··············|·············|·············|···············|··············
|  Diamond                                       ·           -  ·          -  ·    2272246  ·        7.6 %  ·     210.04  │
·················································|··············|·············|·············|···············|··············
|  DiamondInit                                   ·           -  ·          -  ·     779966  ·        2.6 %  ·      72.10  │
·················································|··············|·············|·············|···············|··············
|  Flow                                          ·           -  ·          -  ·    4839853  ·       16.1 %  ·     447.37  │
·················································|··············|·············|·············|···············|··············
|  Loupe                                         ·           -  ·          -  ·     717623  ·        2.4 %  ·      66.33  │
·················································|··············|·············|·············|···············|··············
|  Session                                       ·           -  ·          -  ·    2325413  ·        7.8 %  ·     214.95  │
·················································|··············|·············|·············|···············|··············
|  Utility                                       ·           -  ·          -  ·     654457  ·        2.2 %  ·      60.49  │
·------------------------------------------------|--------------|-------------|-------------|---------------|-------------·
 */
